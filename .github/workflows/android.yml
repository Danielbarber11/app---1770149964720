
name: Build Android
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    permissions: { contents: write }
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with: { node-version: 18 }
      - name: Install and Build
        run: |
          # If a package.json exists in the root or web_files, handle it
          if [ -f "web_files/package.json" ]; then
            cd web_files
            npm install
            if npm run | grep -q "build"; then npm run build; fi
            cd ..
          elif [ -f "package.json" ]; then
            npm install
            if npm run | grep -q "build"; then npm run build; fi
          fi
          
          mkdir -p dist
          # Priority: Build output folders, then static files
          if [ -d "web_files/dist" ]; then cp -r web_files/dist/* dist/;
          elif [ -d "web_files/build" ]; then cp -r web_files/build/* dist/;
          elif [ -d "dist" ] && [ "$(ls -A dist)" ]; then echo "Dist already has build output";
          elif [ -d "build" ]; then cp -r build/* dist/;
          else
            cp -r web_files/* dist/ || true
            cp index.html dist/ || true
          fi
      - run: |
          npm install @capacitor/core @capacitor/cli @capacitor/android
          npx cap add android && npx cap sync
      - name: Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug
          cp app/build/outputs/apk/debug/app-debug.apk ../app-debug.apk
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          files: app-debug.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
